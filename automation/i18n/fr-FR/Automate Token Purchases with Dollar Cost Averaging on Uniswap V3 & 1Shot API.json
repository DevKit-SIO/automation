{
  "id": 8044,
  "name": "Automatiser les achats de jetons avec l'achat progressif sur Uniswap V3 et l'API 1Shot",
  "totalViews": 0,
  "price": 0,
  "purchaseUrl": null,
  "user": {
    "name": "1Shot API",
    "username": "oneshotapi",
    "bio": "1Shot API lets you bring onchain actions into your n8n workflows. ",
    "verified": true,
    "links": [
      "https://1shotapi.com"
    ],
    "avatar": "https://gravatar.com/avatar/2f5dd5c202883a323b48cd379db1880533fe083a2d9a3b2b11ebf6f48a984e78?r=pg&d=retro&size=200"
  },
  "description": "*Ce flux de travail contient des n≈ìuds communautaires qui ne sont compatibles qu'avec la version auto-h√©berg√©e de n8n.*\n\n![DCAdemo.gif](fileId:2287)\n# Achat progressif avec Uniswap V3\n\nCe flux de travail vous permet de configurer un flux de travail programm√© pour acheter progressivement (DCA) n'importe quel jeton selon un calendrier personnalis√© en utilisant [1Shot API](https://1shotapi.com) et le protocole [Uniswap V3](https://app.uniswap.org/). Choisissez votre jeton d'entr√©e et votre jeton de sortie, et configurez √©ventuellement le flux de travail pour vous envoyer des notifications sur Telegram chaque fois que votre flux de travail termine un √©change. \n\n## D√©l√©gation de portefeuille\n\nIl est important de noter que ce flux de travail utilise le [Cadre de D√©l√©gation](https://metamask.io/developer/delegation-toolkit) de Metamask, qui vous permet d'acheter progressivement √† partir d'un compte que vous d√©tenez sans jamais exporter votre cl√© priv√©e ou renoncer au contr√¥le de vos actifs. \n\n## Configuration\n\n1. Cr√©ez un compte gratuit sur [1Shot API](https://1shotapi.com), provisionnez un [portefeuille serveur](https://app.1shotapi.com/wallets) pour relayer les transactions, et g√©n√©rez une cl√© API pour vous connecter √† n8n.  \n2. Importez les [contrats Uniswap](https://docs.uniswap.org/contracts/v3/reference/deployments/) suivants dans votre compte 1Shot API pour la cha√Æne sur laquelle vous souhaitez √©changer : QuoterV2, SwapRouter02, et le pool de jetons (n√©cessaire pour calculer le prix moyen pond√©r√© par le temps (TWAP). \n3. Importez la fonction `approve` pour le jeton ERC-20 que vous souhaitez utiliser pour acheter votre actif cible (ceci devrait √™tre le `token0` ou `token1` du pool que vous avez import√© √† l'√©tape 2).\n4. Cliquez sur les d√©tails du portefeuille serveur que vous avez cr√©√©s, financez-le avec suffisamment de jetons de gaz pour payer vos transactions, puis g√©n√©rez une d√©l√©gation pour le contrat SwapRouter02 et le jeton ERC-20 des √©tapes 2 et 3. \n5. Importez le flux de travail DCA et utilisez votre cl√©/secr√®te 1Shot API pour cr√©er un identifiant. \n6. Orientez les n≈ìuds 1Shot API vers les fonctions de contrat intelligent appropri√©es que vous avez import√©es aux √©tapes 2 et 3. \n7. Dans le n≈ìud `Configurations d'√©change`, d√©finissez le montant du jeton *in* que vous souhaitez d√©penser √† chaque achat - par exemple, si vous utilisez USDC (qui a 6 d√©cimales) et que vous souhaitez acheter 10 $ √† chaque achat, alors `amountDCA` devrait √™tre `10000000`. D√©finissez √©galement les bonnes adresses pour le SwapRouterV2, `token0`, `token1` et `fee` du pool que vous utilisez. \n8. Enfin, d√©finissez la fr√©quence de votre DCA dans le n≈ìud de d√©clenchement et activez-le !\n\n## Notifications Telegram optionnelles\n\nVous pouvez configurer un bot Telegram pour vous notifier chaque fois que le flux de travail se termine afin de vous envoyer un hachage de transaction et votre solde restant dans vos fonds d'achat.",
  "createdAt": "2025-08-30T05:39:26.365Z",
  "nodes": [
    {
      "id": 49,
      "icon": "file:telegram.svg",
      "name": "n8n-nodes-base.telegram",
      "codex": {
        "data": {
          "alias": [
            "human",
            "form",
            "wait",
            "hitl",
            "approval"
          ],
          "resources": {
            "generic": [
              {
                "url": "https://n8n.io/blog/why-business-process-automation-with-n8n-can-change-your-daily-life/",
                "icon": "üß¨",
                "label": "Why business process automation with n8n can change your daily life"
              },
              {
                "url": "https://n8n.io/blog/create-a-toxic-language-detector-for-telegram/",
                "icon": "ü§¨",
                "label": "Create a toxic language detector for Telegram in 4 step"
              },
              {
                "url": "https://n8n.io/blog/automatically-adding-expense-receipts-to-google-sheets-with-telegram-mindee-twilio-and-n8n/",
                "icon": "üßæ",
                "label": "Automatically Adding Expense Receipts to Google Sheets with Telegram, Mindee, Twilio, and n8n"
              },
              {
                "url": "https://n8n.io/blog/no-code-ecommerce-workflow-automations/",
                "icon": "store",
                "label": "6 e-commerce workflows to power up your Shopify s"
              },
              {
                "url": "https://n8n.io/blog/world-poetry-day-workflow/",
                "icon": "üìú",
                "label": "Celebrating World Poetry Day with a daily poem in Telegram"
              },
              {
                "url": "https://n8n.io/blog/using-automation-to-boost-productivity-in-the-workplace/",
                "icon": "üí™",
                "label": "Using Automation to Boost Productivity in the Workplace"
              },
              {
                "url": "https://n8n.io/blog/how-to-set-up-a-ci-cd-pipeline-with-no-code/",
                "icon": "üé°",
                "label": "How to set up a no-code CI/CD pipeline with GitHub and TravisCI"
              },
              {
                "url": "https://n8n.io/blog/creating-scheduled-text-affirmations-with-n8n/",
                "icon": "ü§ü",
                "label": "Creating scheduled text affirmations with n8n"
              },
              {
                "url": "https://n8n.io/blog/creating-telegram-bots-with-n8n-a-no-code-platform/",
                "icon": "üí¨",
                "label": "Creating Telegram Bots with n8n, a No-Code Platform"
              },
              {
                "url": "https://n8n.io/blog/aws-workflow-automation/",
                "label": "7 no-code workflow automations for Amazon Web Services"
              }
            ],
            "primaryDocumentation": [
              {
                "url": "https://docs.n8n.io/integrations/builtin/app-nodes/n8n-nodes-base.telegram/"
              }
            ],
            "credentialDocumentation": [
              {
                "url": "https://docs.n8n.io/integrations/builtin/credentials/telegram/"
              }
            ]
          },
          "categories": [
            "Communication",
            "HITL"
          ],
          "nodeVersion": "1.0",
          "codexVersion": "1.0",
          "subcategories": {
            "HITL": [
              "Human in the Loop"
            ]
          }
        }
      },
      "group": "[\"output\"]",
      "defaults": {
        "name": "Telegram"
      },
      "iconData": {
        "type": "file",
        "fileBuffer": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBmaWxsPSIjZmZmIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiB2aWV3Qm94PSIwIDAgNjYgNjYiPjx1c2UgeGxpbms6aHJlZj0iI2EiIHg9Ii41IiB5PSIuNSIvPjxzeW1ib2wgaWQ9ImEiIG92ZXJmbG93PSJ2aXNpYmxlIj48ZyBmaWxsLXJ1bGU9Im5vbnplcm8iIHN0cm9rZT0ibm9uZSI+PHBhdGggZmlsbD0iIzM3YWVlMiIgZD0iTTAgMzJjMCAxNy42NzMgMTQuMzI3IDMyIDMyIDMyczMyLTE0LjMyNyAzMi0zMlM0OS42NzMgMCAzMiAwIDAgMTQuMzI3IDAgMzIiLz48cGF0aCBmaWxsPSIjYzhkYWVhIiBkPSJtMjEuNjYxIDM0LjMzOCAzLjc5NyAxMC41MDhzLjQ3NS45ODMuOTgzLjk4MyA4LjA2OC03Ljg2NCA4LjA2OC03Ljg2NGw4LjQwNy0xNi4yMzctMjEuMTE5IDkuODk4eiIvPjxwYXRoIGZpbGw9IiNhOWM2ZDgiIGQ9Im0yNi42OTUgMzcuMDM0LS43MjkgNy43NDZzLS4zMDUgMi4zNzMgMi4wNjggMGw0LjY0NC00LjIwMyIvPjxwYXRoIGQ9Im0yMS43MyAzNC43MTItNy44MDktMi41NDVzLS45MzItLjM3OC0uNjMzLTEuMjM3Yy4wNjItLjE3Ny4xODYtLjMyOC41NTktLjU4OCAxLjczMS0xLjIwNiAzMi4wMjgtMTIuMDk2IDMyLjAyOC0xMi4wOTZzLjg1Ni0uMjg4IDEuMzYxLS4wOTdjLjIzMS4wODguMzc4LjE4Ny41MDMuNTQ4LjA0NS4xMzIuMDcxLjQxMS4wNjguNjg5LS4wMDMuMjAxLS4wMjcuMzg2LS4wNDUuNjc4LS4xODQgMi45NzgtNS43MDYgMjUuMTk4LTUuNzA2IDI1LjE5OHMtLjMzIDEuMy0xLjUxNCAxLjM0NWMtLjQzMi4wMTYtLjk1Ni0uMDcxLTEuNTgyLS42MS0yLjMyMy0xLjk5OC0xMC4zNTItNy4zOTQtMTIuMTI2LTguNThhLjM0LjM0IDAgMCAxLS4xNDYtLjIzOWMtLjAyNS0uMTI1LjEwOC0uMjguMTA4LS4yOHMxMy45OC0xMi40MjcgMTQuMzUyLTEzLjczMWMuMDI5LS4xMDEtLjA3OS0uMTUxLS4yMjYtLjEwNy0uOTI5LjM0Mi0xNy4wMjUgMTAuNTA2LTE4LjgwMSAxMS42MjktLjEwNC4wNjYtLjM5NS4wMjMtLjM5NS4wMjMiLz48L2c+PC9zeW1ib2w+PC9zdmc+"
      },
      "displayName": "Telegram",
      "typeVersion": 1,
      "nodeCategories": [
        {
          "id": 6,
          "name": "Communication"
        },
        {
          "id": 28,
          "name": "HITL"
        }
      ]
    },
    {
      "id": 565,
      "icon": "fa:sticky-note",
      "name": "n8n-nodes-base.stickyNote",
      "codex": {
        "data": {
          "alias": [
            "Comments",
            "Notes",
            "Sticky"
          ],
          "categories": [
            "Core Nodes"
          ],
          "nodeVersion": "1.0",
          "codexVersion": "1.0",
          "subcategories": {
            "Core Nodes": [
              "Helpers"
            ]
          }
        }
      },
      "group": "[\"input\"]",
      "defaults": {
        "name": "Note Collante",
        "color": "#FFD233"
      },
      "iconData": {
        "icon": "sticky-note",
        "type": "icon"
      },
      "displayName": "Sticky Note",
      "typeVersion": 1,
      "nodeCategories": [
        {
          "id": 9,
          "name": "Core Nodes"
        }
      ]
    },
    {
      "id": 834,
      "icon": "file:code.svg",
      "name": "n8n-nodes-base.code",
      "codex": {
        "data": {
          "alias": [
            "cpde",
            "Javascript",
            "JS",
            "Python",
            "Script",
            "Custom Code",
            "Function"
          ],
          "details": "The Code node allows you to execute JavaScript in your workflow.",
          "resources": {
            "primaryDocumentation": [
              {
                "url": "https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.code/"
              }
            ]
          },
          "categories": [
            "Development",
            "Core Nodes"
          ],
          "nodeVersion": "1.0",
          "codexVersion": "1.0",
          "subcategories": {
            "Core Nodes": [
              "Helpers",
              "Data Transformation"
            ]
          }
        }
      },
      "group": "[\"transform\"]",
      "defaults": {
        "name": "Code"
      },
      "iconData": {
        "type": "file",
        "fileBuffer": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxnIGNsaXAtcGF0aD0idXJsKCNjbGlwMF8xMTcxXzQ0MSkiPgo8cGF0aCBkPSJNMTcwLjI4MyA0OEgxOTYuNUMyMDMuMTI3IDQ4IDIwOC41IDQyLjYyNzQgMjA4LjUgMzZWMTJDMjA4LjUgNS4zNzI1OCAyMDMuMTI3IDAgMTk2LjUgMEgxNzAuMjgzQzEyNi4xIDAgOTAuMjgzIDM1LjgxNzIgOTAuMjgzIDgwVjE3NkM5MC4yODMgMjA2LjkyOCA2NS4yMTA5IDIzMiAzNC4yODMgMjMySDIzQzE2LjM3MjYgMjMyIDExIDIzNy4zNzIgMTEgMjQ0VjI2OEMxMSAyNzQuNjI3IDE2LjM3MjQgMjgwIDIyLjk5OTYgMjgwTDM0LjI4MyAyODBDNjUuMjEwOSAyODAgOTAuMjgzIDMwNS4wNzIgOTAuMjgzIDMzNlY0NDBDOTAuMjgzIDQ3OS43NjQgMTIyLjUxOCA1MTIgMTYyLjI4MyA1MTJIMTk2LjVDMjAzLjEyNyA1MTIgMjA4LjUgNTA2LjYyNyAyMDguNSA1MDBWNDc2QzIwOC41IDQ2OS4zNzMgMjAzLjEyNyA0NjQgMTk2LjUgNDY0SDE2Mi4yODNDMTQ5LjAyOCA0NjQgMTM4LjI4MyA0NTMuMjU1IDEzOC4yODMgNDQwVjMzNkMxMzguMjgzIDMwOS4wMjIgMTI4LjAxMSAyODQuNDQzIDExMS4xNjQgMjY1Ljk2MUMxMDYuMTA5IDI2MC40MTYgMTA2LjEwOSAyNTEuNTg0IDExMS4xNjQgMjQ2LjAzOUMxMjguMDExIDIyNy41NTcgMTM4LjI4MyAyMDIuOTc4IDEzOC4yODMgMTc2VjgwQzEzOC4yODMgNjIuMzI2OSAxNTIuNjEgNDggMTcwLjI4MyA0OFoiIGZpbGw9IiNGRjk5MjIiLz4KPHBhdGggZD0iTTMwNSAzNkMzMDUgNDIuNjI3NCAzMTAuMzczIDQ4IDMxNyA0OEgzNDIuOTc5QzM2MC42NTIgNDggMzc0Ljk3OCA2Mi4zMjY5IDM3NC45NzggODBWMTc2QzM3NC45NzggMjAyLjk3OCAzODUuMjUxIDIyNy41NTcgNDAyLjA5OCAyNDYuMDM5QzQwNy4xNTMgMjUxLjU4NCA0MDcuMTUzIDI2MC40MTYgNDAyLjA5OCAyNjUuOTYxQzM4NS4yNTEgMjg0LjQ0MyAzNzQuOTc4IDMwOS4wMjIgMzc0Ljk3OCAzMzZWNDMyQzM3NC45NzggNDQ5LjY3MyAzNjAuNjUyIDQ2NCAzNDIuOTc5IDQ2NEgzMTdDMzEwLjM3MyA0NjQgMzA1IDQ2OS4zNzMgMzA1IDQ3NlY1MDBDMzA1IDUwNi42MjcgMzEwLjM3MyA1MTIgMzE3IDUxMkgzNDIuOTc5QzM4Ny4xNjEgNTEyIDQyMi45NzggNDc2LjE4MyA0MjIuOTc4IDQzMlYzMzZDNDIyLjk3OCAzMDUuMDcyIDQ0OC4wNTEgMjgwIDQ3OC45NzkgMjgwSDQ5MEM0OTYuNjI3IDI4MCA1MDIgMjc0LjYyOCA1MDIgMjY4VjI0NEM1MDIgMjM3LjM3MyA0OTYuNjI4IDIzMiA0OTAgMjMyTDQ3OC45NzkgMjMyQzQ0OC4wNTEgMjMyIDQyMi45NzggMjA2LjkyOCA0MjIuOTc4IDE3NlY4MEM0MjIuOTc4IDM1LjgxNzIgMzg3LjE2MSAwIDM0Mi45NzkgMEgzMTdDMzEwLjM3MyAwIDMwNSA1LjM3MjU4IDMwNSAxMlYzNloiIGZpbGw9IiNGRjk5MjIiLz4KPC9nPgo8ZGVmcz4KPGNsaXBQYXRoIGlkPSJjbGlwMF8xMTcxXzQ0MSI+CjxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiBmaWxsPSJ3aGl0ZSIvPgo8L2NsaXBQYXRoPgo8L2RlZnM+Cjwvc3ZnPgo="
      },
      "displayName": "Code",
      "typeVersion": 2,
      "nodeCategories": [
        {
          "id": 5,
          "name": "Development"
        },
        {
          "id": 9,
          "name": "Core Nodes"
        }
      ]
    },
    {
      "id": 839,
      "icon": "fa:clock",
      "name": "n8n-nodes-base.scheduleTrigger",
      "codex": {
        "data": {
          "alias": [
            "Time",
            "Scheduler",
            "Polling",
            "Cron",
            "Interval"
          ],
          "resources": {
            "generic": [],
            "primaryDocumentation": [
              {
                "url": "https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.scheduletrigger/"
              }
            ]
          },
          "categories": [
            "Core Nodes"
          ],
          "nodeVersion": "1.0",
          "codexVersion": "1.0"
        }
      },
      "group": "[\"trigger\",\"schedule\"]",
      "defaults": {
        "name": "D√©clencheur de Planification",
        "color": "#31C49F"
      },
      "iconData": {
        "icon": "clock",
        "type": "icon"
      },
      "displayName": "Schedule Trigger",
      "typeVersion": 1,
      "nodeCategories": [
        {
          "id": 9,
          "name": "Core Nodes"
        }
      ]
    }
  ],
  "views": 0,
  "recentViews": 0,
  "workflow": {
    "id": "maYy0i7nYbJwepaQ",
    "meta": {
      "instanceId": "62f017ec8f130d172e2e5f39bbf09515036bfd403dfa60fe06f5ab14b78705d0",
      "templateCredsSetupCompleted": true
    },
    "name": "DCA w/ Uniswap V3",
    "tags": [],
    "nodes": [
      {
        "id": "f43b592f-1203-47b8-9dac-61e8a9d3c9d3",
        "name": "Calculate TWAP",
        "type": "n8n-nodes-base.code",
        "position": [
          432,
          160
        ],
        "parameters": {
          "jsCode": "// Constants\nconst MaxUint256 = (1n << 256n) - 1n;\nconst Q32 = 1n << 32n;\nconst ZERO = 0n;\nconst ONE = 1n;\n\nfunction mulShift(val, mulBy) {\n  return (val * BigInt(mulBy)) >> 128n;\n}\n\n/**\n * Returns the sqrt ratio as a Q64.96 for the given tick.\n * The sqrt ratio is computed as sqrt(1.0001)^tick\n * @param {number} tick the tick for which to compute the sqrt ratio\n */\nfunction getSqrtRatioAtTick(tick) {\n  if (!Number.isInteger(tick)) throw new Error(\"Tick must be integer\");\n  const MIN_TICK = -887272;\n  const MAX_TICK = 887272;\n\n  if (tick < MIN_TICK || tick > MAX_TICK) throw new Error(\"Tick out of bounds\");\n\n  const absTick = tick < 0 ? -tick : tick;\n\n  let ratio =\n    (absTick & 0x1) != 0\n      ? 0xfffcb933bd6fad37aa2d162d1a594001n\n      : 0x100000000000000000000000000000000n;\n  if ((absTick & 0x2) != 0) ratio = mulShift(ratio, 0xfff97272373d413259a46990580e213an);\n  if ((absTick & 0x4) != 0) ratio = mulShift(ratio, 0xfff2e50f5f656932ef12357cf3c7fdccn);\n  if ((absTick & 0x8) != 0) ratio = mulShift(ratio, 0xffe5caca7e10e4e61c3624eaa0941cd0n);\n  if ((absTick & 0x10) != 0) ratio = mulShift(ratio, 0xffcb9843d60f6159c9db58835c926644n);\n  if ((absTick & 0x20) != 0) ratio = mulShift(ratio, 0xff973b41fa98c081472e6896dfb254c0n);\n  if ((absTick & 0x40) != 0) ratio = mulShift(ratio, 0xff2ea16466c96a3843ec78b326b52861n);\n  if ((absTick & 0x80) != 0) ratio = mulShift(ratio, 0xfe5dee046a99a2a811c461f1969c3053n);\n  if ((absTick & 0x100) != 0) ratio = mulShift(ratio, 0xfcbe86c7900a88aedcffc83b479aa3a4n);\n  if ((absTick & 0x200) != 0) ratio = mulShift(ratio, 0xf987a7253ac413176f2b074cf7815e54n);\n  if ((absTick & 0x400) != 0) ratio = mulShift(ratio, 0xf3392b0822b70005940c7a398e4b70f3n);\n  if ((absTick & 0x800) != 0) ratio = mulShift(ratio, 0xe7159475a2c29b7443b29c7fa6e889d9n);\n  if ((absTick & 0x1000) != 0) ratio = mulShift(ratio, 0xd097f3bdfd2022b8845ad8f792aa5825n);\n  if ((absTick & 0x2000) != 0) ratio = mulShift(ratio, 0xa9f746462d870fdf8a65dc1f90e061e5n);\n  if ((absTick & 0x4000) != 0) ratio = mulShift(ratio, 0x70d869a156d2a1b890bb3df62baf32f7n);\n  if ((absTick & 0x8000) != 0) ratio = mulShift(ratio, 0x31be135f97d08fd981231505542fcfa6n);\n  if ((absTick & 0x10000) != 0) ratio = mulShift(ratio, 0x9aa508b5b7a84e1c677de54f3e99bc9n);\n  if ((absTick & 0x20000) != 0) ratio = mulShift(ratio, 0x5d6af8dedb81196699c329225ee604n);\n  if ((absTick & 0x40000) != 0) ratio = mulShift(ratio, 0x2216e584f5fa1ea926041bedfe98n);\n  if ((absTick & 0x80000) != 0) ratio = mulShift(ratio, 0x48a170391f7dc42444e8fa2n);\n\n  if (tick > 0) {\n    ratio = MaxUint256 / ratio;\n  }\n\n  // back to Q96\n  return ratio % Q32 > 0n ? ratio / Q32 + ONE : ratio / Q32;\n}\n\nfunction getPriceFromSqrtPriceX96(sqrtPriceX96, decimals0, decimals1) {\n  // Ensure input is BigInt\n  const sqrtPrice = BigInt(sqrtPriceX96.toString());\n\n  // (sqrtPriceX96 ^ 2)\n  const numerator = sqrtPrice * sqrtPrice;\n\n  // Denominator = 2^192\n  const denominator = 1n << 192n;\n\n  // Raw price ratio (token1 per token0, no decimals adjusted)\n  let ratio = Number(numerator * 10n**18n / denominator) / 1e18; \n  // (we scale by 1e18 to stay precise when converting to Number)\n\n  // Adjust for token decimals\n  const decimalFactor = 10 ** (decimals0 - decimals1);\n  const price = ratio * decimalFactor;\n\n  return price;\n}\n\nconst diffTickCumulative = parseInt($('Fetch Pool TWA Observations').first().json.response[0][0]) - parseInt($('Fetch Pool TWA Observations').first().json.response[0][1]);\nconst diffSecondsPerLIquidityX128 = parseInt($('Fetch Pool TWA Observations').first().json.response[1][0]) - parseInt($('Fetch Pool TWA Observations').first().json.response[1][1]);\nconst secondsBetween = parseInt($('Swap Configs').first().json.secondsAgo);\nconst secondsBetweenX128 = BigInt(secondsBetween) << BigInt(128);\nconst averageTick = parseInt(diffTickCumulative/secondsBetween);\n\nconst sqrtPriceX96After = $input.first().json.result.decodedData[1];\nconst priceAfter = getPriceFromSqrtPriceX96(sqrtPriceX96After, 6, 8);\n\nconst sqrtTWAPricex96 = getSqrtRatioAtTick(averageTick);\nconst TWAP = getPriceFromSqrtPriceX96(sqrtTWAPricex96, 6,8);\nconst TWAL = secondsBetweenX128 / BigInt(diffSecondsPerLIquidityX128);\n\nconsole.log(\"TWAP\", 1/TWAP);\nconsole.log(\"Price After: \", 1/priceAfter);\nconsole.log(\"TWAL\", TWAL);\n\n$input.first().json.twap = TWAP; \n$input.first().json.sqrtTWAPriceX96 = sqrtTWAPricex96; \n$input.first().json.twal = TWAL; \n$input.first().json.quotePriceAfter = priceAfter; \n\nreturn $input.all()\n"
        },
        "typeVersion": 2
      },
      {
        "id": "bd180960-416b-48f8-b524-9841428a34e9",
        "name": "Fetch Pool TWA Observations",
        "type": "n8n-nodes-1shot.oneShot",
        "position": [
          -16,
          160
        ],
        "parameters": {
          "params": "={\n  \"secondsAgos\": [\"0\",\"{{ $json.secondsAgo }}\"]\n} ",
          "operation": "read",
          "contractMethodId": "19aa2a88-2121-4727-b1af-e4922259b645"
        },
        "credentials": {
          "oneShotOAuth2Api": {
            "id": "nkfF9AitCKUCrErK",
            "name": "1Shot account"
          }
        },
        "typeVersion": 1
      },
      {
        "id": "46184b6b-263e-4e14-9518-2515e2d311a3",
        "name": "Get Swap Qoute",
        "type": "n8n-nodes-1shot.oneShot",
        "position": [
          208,
          160
        ],
        "parameters": {
          "params": "={\n  \"params\": \n    {\n  \"tokenIn\": \"{{ $('Swap Configs').item.json.token0 }}\",\n  \"tokenOut\": \"{{ $('Swap Configs').item.json.token1 }}\",\n  \"amountIn\": \"{{ $('Swap Configs').item.json.secondsAgo }}\",\n  \"fee\": \"500\",\n  \"sqrtPriceLimitX96\": \"0\"\n    }\n} ",
          "operation": "simulate",
          "contractMethodId": "8de7d518-a62a-4a05-8f79-68808b6fd609"
        },
        "credentials": {
          "oneShotOAuth2Api": {
            "id": "nkfF9AitCKUCrErK",
            "name": "1Shot account"
          }
        },
        "typeVersion": 1
      },
      {
        "id": "6b4d7900-7fae-4c1d-80cf-2900dfb4e299",
        "name": "Swap Tokens",
        "type": "n8n-nodes-1shot.oneShotSynch",
        "onError": "continueRegularOutput",
        "position": [
          880,
          80
        ],
        "parameters": {
          "params": "={\n\"params\": {\n\"tokenIn\": \"{{ $('Swap Configs').item.json.token0 }}\",\n\"tokenOut\": \"{{ $('Swap Configs').item.json.token1 }}\",\n\"fee\": \"{{ $('Swap Configs').item.json.fee }}\",\n\"recipient\": \"{{ $('Swap Configs').item.json.delegator }}\",\n\"amountIn\": \"{{ $('Swap Configs').item.json.amountDCA }}\",\n\"amountOutMinimum\": \"0\",\n\"sqrtPriceLimitX96\": \"{{ $('Calculate TWAP').item.json.sqrtTWAPriceX96 }}\"\n}\n}",
          "operation": "executeAsDelegator",
          "additionalFields": {
            "memo": "=DCA Swap for {{ $('Swap Configs').item.json.amountDCA }}, TWAP: {{ $('Calculate TWAP').item.json.twap }}"
          },
          "contractMethodId": "86616048-5330-452f-8637-58859dc872c6",
          "delegatorWalletAddress": "={{ $('Swap Configs').item.json.delegator }}"
        },
        "credentials": {
          "oneShotOAuth2Api": {
            "id": "nkfF9AitCKUCrErK",
            "name": "1Shot account"
          }
        },
        "typeVersion": 1
      },
      {
        "id": "a11c7481-97bf-4cee-8a3f-e604cd09236d",
        "name": "Schedule Trigger",
        "type": "n8n-nodes-base.scheduleTrigger",
        "position": [
          -464,
          160
        ],
        "parameters": {
          "rule": {
            "interval": [
              {
                "field": "minutes",
                "minutesInterval": 10
              }
            ]
          }
        },
        "typeVersion": 1.2
      },
      {
        "id": "8c435f3f-72dc-4102-99bd-13cda1ea27c8",
        "name": "Failure Details",
        "type": "n8n-nodes-base.telegram",
        "position": [
          1104,
          256
        ],
        "webhookId": "4bc3c459-fb40-44e5-a4b6-8565f2e92b62",
        "parameters": {
          "text": "=‚ùå Swap Failed",
          "chatId": "5034284669",
          "additionalFields": {}
        },
        "credentials": {
          "telegramApi": {
            "id": "uN6xtW1sUnA0WiMc",
            "name": "@1shotdemobot"
          }
        },
        "typeVersion": 1.2
      },
      {
        "id": "d1512fe2-112f-48c0-8a98-cbbb08ab8f65",
        "name": "Sticky Note",
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -864,
          224
        ],
        "parameters": {
          "width": 320,
          "height": 224,
          "content": "## Set Your DCA Schedule\n\nn8n makes it really easy to set a recurring schedule for your DCA purchases. Click on the Schedule Trigger node and set your frequency. "
        },
        "typeVersion": 1
      },
      {
        "id": "4f6661d0-978c-4554-97eb-f91519dd8c85",
        "name": "Sticky Note1",
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -528,
          -160
        ],
        "parameters": {
          "width": 720,
          "height": 256,
          "content": "## DCA configs\n\nSince we are using the Uniswap protocol directly, you'll need to set a few parameters in the Swap Configs node. \n\n1. Decide on the amount you want to spend on each DCA buy. \n2. Set the correct address for the Uniswap [SwapRouter](https://docs.uniswap.org/contracts/v3/reference/deployments/) contract\n3. Depending on the pool your are trading against, set the correct addresses for `token0` and `token1`. \n4. Also be sure to set the correct fee for the pool you are trading against (for most pools its just `500`). "
        },
        "typeVersion": 1
      },
      {
        "id": "4b46e786-07d6-4184-8a90-ff264686c075",
        "name": "Sticky Note2",
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -128,
          352
        ],
        "parameters": {
          "width": 672,
          "height": 288,
          "content": "## Connect to Your 1Shot API Account\n\nCreate an API key and secret in your 1Shot API account and connect your n8n instance by creating a credential. \n\n1. The `Fetch Pool TWA Observactions` should point to the `observe` method on your target trading pool (like this [one](https://app.uniswap.org/explore/pools/base/0xfBB6Eed8e7aa03B138556eeDaF5D271A5E1e43ef)). \n2. The `Get Swap Quote` should point to the `quoteExactInputSingle` on the QuoterV2 contract.\n3. The `Give Approval to Router` should call `approve` on the token you are DCA'ing out of. \n4. The `Swap Tokens` node should point at the `exactInputSingle` function on the Uniswap SwapRouterV2 contract. "
        },
        "typeVersion": 1
      },
      {
        "id": "bb585dd2-901b-4bb3-b822-5ddf3ad80be7",
        "name": "Give Approval to Router",
        "type": "n8n-nodes-1shot.oneShotSynch",
        "onError": "continueRegularOutput",
        "position": [
          656,
          160
        ],
        "parameters": {
          "params": "={\n  \"spender\": \"{{ $('Swap Configs').item.json.router }}\", \n  \"value\": \"{{ $('Swap Configs').item.json.amountDCA }}\"\n} ",
          "operation": "executeAsDelegator",
          "additionalFields": {
            "memo": "=DCA Approve for {{ $('Swap Configs').item.json.amountDCA }}"
          },
          "contractMethodId": "b2c3382b-37d0-4d49-b5d2-d1c6e8770658",
          "delegatorWalletAddress": "={{ $('Swap Configs').item.json.delegator }}"
        },
        "credentials": {
          "oneShotOAuth2Api": {
            "id": "nkfF9AitCKUCrErK",
            "name": "1Shot account"
          }
        },
        "typeVersion": 1
      },
      {
        "id": "792928fb-59e5-44ba-a6b9-9f388c74f02a",
        "name": "Sticky Note3",
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          1344,
          224
        ],
        "parameters": {
          "width": 544,
          "height": 176,
          "content": "## Telegram Notifications\n\nIf you want to get notified on each DCA purchase, connect a Telegram bot. "
        },
        "typeVersion": 1
      },
      {
        "id": "2edc9432-92f2-4feb-a44a-f6d6f5608db1",
        "name": "Success Details",
        "type": "n8n-nodes-base.telegram",
        "position": [
          1328,
          32
        ],
        "webhookId": "4bc3c459-fb40-44e5-a4b6-8565f2e92b62",
        "parameters": {
          "text": "=‚úÖ Swapped `{{ $('Swap Configs').item.json.amountDCA }}` `{{ $('Swap Configs').item.json.token0 }}` for {{ $('Get Swap Qoute').item.json.result.decodedData[0] }} {{ $('Swap Configs').item.json.token1 }}. \n\nThe `{{ $('Swap Configs').item.json.secondsAgo }}` second TWAP was `{{ $('Calculate TWAP').item.json.twap }}`. Your tx hash is `{{ $('Swap Tokens').item.json.transactionHash }}`.\n\nYou have {{ $json.response }} of token `{{ $('Swap Configs').item.json.token0 }}` left. ",
          "chatId": "5034284669",
          "additionalFields": {}
        },
        "credentials": {
          "telegramApi": {
            "id": "uN6xtW1sUnA0WiMc",
            "name": "@1shotdemobot"
          }
        },
        "typeVersion": 1.2
      },
      {
        "id": "3147ded9-fc81-4d00-b230-c313c0c3501a",
        "name": "Get Remaining DCA Funds Balance",
        "type": "n8n-nodes-1shot.oneShot",
        "position": [
          1104,
          32
        ],
        "parameters": {
          "params": "={\n  \"account\": \"{{ $('Swap Configs').item.json.delegator }}\"\n}",
          "operation": "read",
          "contractMethodId": "5fa806d3-e891-43de-b834-38f82dae653e"
        },
        "credentials": {
          "oneShotOAuth2Api": {
            "id": "nkfF9AitCKUCrErK",
            "name": "1Shot account"
          }
        },
        "typeVersion": 1
      },
      {
        "id": "4d7da856-78f7-4553-a9f7-2a372688712b",
        "name": "Swap Configs",
        "type": "n8n-nodes-base.code",
        "position": [
          -240,
          160
        ],
        "parameters": {
          "jsCode": "const secondsAgo = 120; // the size of your TWAP window\nconst amountDCA = 100000; // amount to swap each time\nconst delegator = \"0x9fead8b19c044c2f404dac38b925ea16adaa2954\"; // your delegated wallet address.\nconst router = \"0x3bFA4769FB09eefC5a80d6E87c3B9C650f7Ae48E\"; // the uniswap SwapRouterV2\nconst token0 = \"0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238\"; // token0 of you r target pool\nconst token1 = \"0xfFf9976782d46CC05630D1f6eBAb18b2324d6B14\"; // token1 of your target pool\nconst fee = 500; // the fee of your target pool\n\n$input.first().json.secondsAgo = secondsAgo;\n$input.first().json.amountDCA = amountDCA;\n$input.first().json.delegator = delegator;\n$input.first().json.router = router;\n$input.first().json.token0 = token0;\n$input.first().json.token1 = token1;\n$input.first().json.fee = fee;\n\nreturn $input.all();\n"
        },
        "typeVersion": 2
      }
    ],
    "active": false,
    "pinData": {},
    "settings": {
      "executionOrder": "v1"
    },
    "versionId": "8c4f8d71-a91f-4481-a83b-17404b73e600",
    "connections": {
      "Swap Tokens": {
        "main": [
          [
            {
              "node": "Get Remaining DCA Funds Balance",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Failure Details",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Swap Configs": {
        "main": [
          [
            {
              "node": "Fetch Pool TWA Observations",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Calculate TWAP": {
        "main": [
          [
            {
              "node": "Give Approval to Router",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Swap Qoute": {
        "main": [
          [
            {
              "node": "Calculate TWAP",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Schedule Trigger": {
        "main": [
          [
            {
              "node": "Swap Configs",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Give Approval to Router": {
        "main": [
          [
            {
              "node": "Swap Tokens",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Failure Details",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Fetch Pool TWA Observations": {
        "main": [
          [
            {
              "node": "Get Swap Qoute",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get Remaining DCA Funds Balance": {
        "main": [
          [
            {
              "node": "Success Details",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    }
  },
  "lastUpdatedBy": 62,
  "workflowInfo": {
    "nodeCount": 14,
    "nodeTypes": {
      "n8n-nodes-base.code": {
        "count": 2
      },
      "n8n-nodes-1shot.oneShot": {
        "count": 3
      },
      "n8n-nodes-base.telegram": {
        "count": 2
      },
      "n8n-nodes-base.stickyNote": {
        "count": 4
      },
      "n8n-nodes-1shot.oneShotSynch": {
        "count": 2
      },
      "n8n-nodes-base.scheduleTrigger": {
        "count": 1
      }
    }
  },
  "categories": [
    {
      "id": 44,
      "name": "Trading Crypto"
    },
    {
      "id": 51,
      "name": "IA Multimodale"
    }
  ],
  "image": [
    {
      "id": 2287,
      "url": "https://n8niostorageaccount.blob.core.windows.net/n8nio-strapi-blobs-prod/assets/DCA_demo_faeb3ff328.gif"
    }
  ]
}